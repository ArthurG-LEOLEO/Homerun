---
import { storyblokEditable, type SbBlokData } from "@storyblok/astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";

import Title from "../../components/atoms/Title.astro";
import SBImage from "../../components/global/SBImage.astro";
import Accordions from "../sections/Accordions.astro";
import ArrowLink from "../../components/atoms/ArrowLink.astro";
import TeamGroup from "../../components/atoms/TeamGroup.astro";
import SBRichText from "../../components/global/SBRichText.astro";

const { language, blok } = Astro.props;
---

<div id="page-creative-plans" class="page" {...storyblokEditable(blok)}>
    <div class="container-main overflow-hidden pt-150 pb-50 lg:pt-135 lg:pb-30">
        <div class="flex flex-col items-center">
            {
                blok.subtitle && (
                    <span class="page-subtitle text-tag-big mb-24 flex items-center justify-center rounded-[5rem] border-3 px-16 py-12 opacity-0 lg:mb-30 lg:px-24 lg:py-13">
                        {blok.subtitle}
                    </span>
                )
            }
            <div
                class={`flex flex-col gap-24 justify-center lg:justify-between lg:flex-row lg:items-center lg:gap-0 ${!blok.subtitle ? "pt-40 lg:pt-80" : ""}`}
            >
                <div
                    class="hero-image px-gutter w-10/12 opacity-0 lg:w-1/2 lg:flex-none"
                >
                    <SBImage
                        class="size-full object-cover"
                        image={blok.hero_image}
                    />
                </div>
                <h1
                    id="page-title"
                    class="text-title-3 px-gutter text-center lg:w-1/2 lg:flex-none lg:text-left"
                >
                    <Title reveal="manual" title={blok.title[0]} />
                </h1>
            </div>
        </div>
    </div>
    <div>
        {
            blok.sections?.map((blok: SbBlokData) => {
                return <StoryblokComponent blok={blok} language={language} />;
            })
        }
    </div>
    <div
        id="faq-section"
        class="container-main bg-pink py-80 md:pt-140 md:pb-185"
    >
        <div
            class="flex flex-col items-center gap-56 lg:flex-row lg:items-start xl:mx-auto xl:w-10/12"
        >
            <div
                class="faq-header px-gutter w-10/12 opacity-0 lg:flex lg:w-4/12 lg:flex-col lg:gap-40 xl:w-3/10"
            >
                <h2 class="text-title-2">{blok.faq_title}</h2>
                <div class="hidden lg:block">
                    <ArrowLink
                        className="faq-interested-link"
                        label={blok.faq_interested_label}
                    />
                </div>
            </div>
            <div
                class="faq-accordions px-gutter w-full opacity-0 lg:w-8/12 xl:w-7/10"
            >
                {
                    blok.faq_accordions?.map((blok: SbBlokData) => {
                        return (
                            <Accordions
                                blok={blok}
                                language={language}
                                inline={true}
                            />
                        );
                    })
                }
            </div>
            <div class="faq-link-mobile px-gutter opacity-0 lg:hidden">
                <ArrowLink
                    className="faq-interested-link"
                    label={blok.faq_interested_label}
                />
            </div>
        </div>
    </div>
    <div
        id="team-section"
        class="container-main flex flex-col gap-56 pt-60 pb-35 lg:mx-auto lg:w-10/12 lg:gap-80 lg:pt-115 xl:w-8/12"
    >
        <div class="flex flex-col gap-56">
            <div class="team-title px-gutter text-center opacity-0">
                <h3 class="text-title-3">{blok.team_title}</h3>
            </div>
            <div
                class="team-groups flex flex-col gap-40 opacity-0 md:flex-row md:gap-0"
            >
                {
                    blok.team_groups?.map(
                        (group: SbBlokData, index: number) => {
                            return (
                                <TeamGroup
                                    blok={group}
                                    description={blok.team_groups_description}
                                    index={index}
                                />
                            );
                        },
                    )
                }
            </div>
        </div>
        <div class="team-quote px-gutter opacity-0">
            <div
                class="bg-green rotate-[-1.2deg] px-32 py-40 text-white md:p-72"
            >
                <SBRichText content={blok.team_quote} textSize="medium" />
            </div>
        </div>
    </div>
</div>

<script>
    import { waitForFooterSplineLoad } from "../../scripts/spline";

    const handleInterestedCtaClick = (planTitle: string) => {
        // Detect current language from URL
        const currentPath = window.location.pathname;
        const langMatch = currentPath.match(/^\/([a-z]{2})\//);
        const currentLang = langMatch ? langMatch[1] : "";

        // Construct contact URL with proper language prefix
        const contactUrl = currentLang ? `/${currentLang}/contact` : "/contact";
        const fullContactUrl = new URL(contactUrl, location.origin);
        fullContactUrl.searchParams.append("planTitle", planTitle);

        window.location.href = fullContactUrl.toString();
    };

    let page: HTMLElement | null;

    let tlAppear: gsap.core.Timeline;

    const animateFaqSection = () => {
        const faqSection = document.getElementById("faq-section");
        const faqHeader = document.querySelector(".faq-header");
        const faqAccordions = document.querySelector(".faq-accordions");
        const faqLinkMobile = document.querySelector(".faq-link-mobile");

        if (faqSection && faqHeader && faqAccordions) {
            gsap.set([faqHeader, faqAccordions, faqLinkMobile], {
                y: "3rem",
                opacity: 0,
            });

            gsap.timeline({
                scrollTrigger: {
                    trigger: faqSection,
                    start: "top 80%",
                    once: true,
                },
            }).to([faqHeader, faqAccordions, faqLinkMobile], {
                duration: 0.8,
                y: 0,
                opacity: 1,
                stagger: 0.15,
                ease: "elastic.out(1,0.7)",
            });
        }
    };

    const animateTeamSection = () => {
        const teamSection = document.getElementById("team-section");
        const teamTitle = document.querySelector(".team-title");
        const teamGroups = document.querySelector(".team-groups");
        const teamQuote = document.querySelector(".team-quote");

        if (teamSection && teamTitle && teamGroups && teamQuote) {
            gsap.set([teamTitle, teamGroups, teamQuote], {
                y: "3rem",
                opacity: 0,
            });

            gsap.timeline({
                scrollTrigger: {
                    trigger: teamSection,
                    start: "top 80%",
                    once: true,
                },
            })
                .to(teamTitle, {
                    duration: 0.8,
                    y: 0,
                    opacity: 1,
                    ease: "elastic.out(1,0.7)",
                })
                .to(
                    teamGroups,
                    {
                        duration: 0.8,
                        y: 0,
                        opacity: 1,
                        ease: "elastic.out(1,0.7)",
                    },
                    "-=0.4",
                )
                .to(
                    teamQuote,
                    {
                        duration: 0.8,
                        y: 0,
                        opacity: 1,
                        ease: "elastic.out(1,0.7)",
                    },
                    "-=0.4",
                );
        }
    };

    const init = async () => {
        page = document.querySelector("#page-creative-plans");
        if (!page) return;

        const banner = document.querySelector("#layout-banner");
        const header = document.querySelectorAll(
            "#layout-header .layout-header",
        );
        const subtitle = page.querySelectorAll(".page-subtitle");

        const titleWordsDesktop = page.querySelectorAll(
            "#page-title .title-wrap-desktop .word-inner",
        );
        const titleWordsMobile = page.querySelectorAll(
            "#page-title .title-wrap-mobile .word-inner",
        );
        const heroImage = page.querySelector(".hero-image");

        await waitForFooterSplineLoad();

        gsap.timeline()
            .set(banner, {
                y: "-100%",
            })
            .set(header, {
                y: -50,
                opacity: 0,
            })
            .set([titleWordsDesktop, titleWordsMobile], {
                y: "100%",
                opacity: 1,
            })
            .set(heroImage, {
                y: "3rem",
                opacity: 0,
            });

        if (subtitle.length > 0) {
            gsap.set(subtitle, {
                scale: 0.7,
                opacity: 0,
            });
        }

        tlAppear = gsap
            .timeline({
                paused: true,
                delay: window.innerWidth >= 1024 ? 0.3 : 0,
            })
            .to(
                banner,
                {
                    y: 0,
                    duration: 0.6,
                    ease: "expo.out",
                },
                "start",
            )
            .to(
                header,
                {
                    y: 0,
                    opacity: 1,
                    duration: 0.6,
                    ease: "expo.out",
                },
                "start",
            );

        if (subtitle.length > 0) {
            tlAppear.to(
                subtitle,
                {
                    opacity: 1,
                    scale: 1,
                    duration: 1,
                    ease: "elastic.out(1.2,0.7)",
                },
                "start+=0.1",
            );
        }

        tlAppear.to(
            heroImage,
            {
                duration: 0.8,
                y: 0,
                opacity: 1,
                ease: "elastic.out(1,0.7)",
            },
            "start+=0.1",
        );

        if (window.innerWidth > 1024) {
            tlAppear
                .to(
                    titleWordsDesktop,
                    {
                        duration: 0.8,
                        y: 0,
                        stagger: 0.05,
                        ease: "elastic.out(1,0.7)",
                    },
                    "start+=0.1",
                )
                .set(titleWordsMobile, {
                    y: 0,
                });
        } else {
            tlAppear
                .to(
                    titleWordsMobile,
                    {
                        duration: 0.8,
                        y: 0,
                        stagger: 0.05,
                        ease: "elastic.out(1,0.7)",
                    },
                    "start+=0.1",
                )
                .set(titleWordsDesktop, {
                    y: 0,
                });
        }

        tlAppear.play();

        // Animate FAQ and Team sections on scroll
        animateFaqSection();
        animateTeamSection();

        // Handle interested link click
        const interestedLinks = document.querySelectorAll(
            ".faq-interested-link",
        );
        interestedLinks.forEach((link) => {
            link.addEventListener("click", () => {
                handleInterestedCtaClick("Start");
            });
        });
    };

    const cleanup = () => {
        tlAppear?.kill();

        // Clean up ScrollTrigger instances
        ScrollTrigger.getAll().forEach((trigger: any) => {
            if (
                trigger.trigger === document.getElementById("faq-section") ||
                trigger.trigger === document.getElementById("team-section")
            ) {
                trigger.kill();
            }
        });
    };

    document.addEventListener("storyblok-live-preview-updated", () => {
        cleanup();
        init();
    });

    document.addEventListener("astro:page-load", () => {
        init();
    });
    document.addEventListener("astro:before-swap", () => {
        cleanup();
    });
</script>
